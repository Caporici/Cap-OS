# -----------------------------------------------------------------------------
# Máquina alvo e Hardware
# -----------------------------------------------------------------------------
MACHINE = "raspberrypi4"
ENABLE_UART = "1"
ENABLE_SPI_BUS = "1"

# Vital para o Kernel 6.6 instalar os módulos na imagem
IMAGE_INSTALL:append = " kernel-modules"

# Configuração automática do config.txt (O MAPA DA TELA)
# Aqui usamos a overlay customizada tft35a que você adicionou
RPI_EXTRA_CONFIG = " \n \
dtparam=spi=on \n \
dtoverlay=tft35a,rotate=90,speed=16000000 \n \
hdmi_force_hotplug=1 \n \
"

# -----------------------------------------------------------------------------
# Distribuição e Init Manager (Systemd)
# -----------------------------------------------------------------------------
DISTRO ?= "poky"
CONF_VERSION = "2"

DISTRO_FEATURES:append = " systemd usrmerge"
VIRTUAL-RUNTIME_init_manager = "systemd"
VIRTUAL-RUNTIME_initscripts = ""

# -----------------------------------------------------------------------------
# Instalação de Pacotes (Rede, Drivers da Tela e Gráficos)
# -----------------------------------------------------------------------------
IMAGE_INSTALL:append = " \
    dhcpcd \
    openssh \
    iproute2 \
    iputils-ping \
    kernel-module-fbtft \
    kernel-module-fb-ili9486 \
    custom-tft-overlay \
    python3 \
    python3-pip \
"
# -----------------------------------------------------------------------------
# Funcionalidades da Imagem (SSH e Root sem senha para teste)
# -----------------------------------------------------------------------------
# debug-tweaks permite login root sem senha
EXTRA_IMAGE_FEATURES ?= "debug-tweaks"
IMAGE_FEATURES += " ssh-server-openssh"

# -----------------------------------------------------------------------------
# Configurações de Build
# -----------------------------------------------------------------------------
USER_CLASSES ?= "buildstats"
PATCHRESOLVE = "noop"
BB_SANDBOX = "0"

# Formato da imagem para gravar no SD
IMAGE_FSTYPES += "wic wic.bz2"

# Monitoramento de espaço em disco
BB_DISKMON_DIRS ??= "\
    STOPTASKS,${TMPDIR},1G,100K \
    STOPTASKS,${DL_DIR},1G,100K \
    STOPTASKS,${SSTATE_DIR},1G,100K \
    STOPTASKS,/tmp,100M,100K \
    HALT,${TMPDIR},100M,1K \
    HALT,${DL_DIR},100M,1K \
    HALT,${SSTATE_DIR},100M,1K \
    HALT,/tmp,10M,1K \
"

# Isso força o Yocto a copiar o arquivo da receita para a partição de BOOT do arquivo .wic
IMAGE_BOOT_FILES:append = " tft35a.dtbo;overlays/tft35a.dtbo"
